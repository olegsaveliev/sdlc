name: Module - AI Automation Tests

on:
  workflow_call:
    secrets:
      OPENAI_KEY:
        required: true
      JIRA_BASE_URL:
        required: false
      JIRA_USER_EMAIL:
        required: false
      JIRA_API_TOKEN:
        required: false
      TRACKER_ENDPOINT:           # â† ADD THIS
        required: false
      TRACKER_API_KEY:            # â† ADD THIS
        required: false

jobs:
  generate-and-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Install Dependencies
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 1: Installing Python dependencies"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pip install openai pytest httpx requests
          if [ -f requirements.txt ]; then
            echo "ğŸ“„ Found requirements.txt - installing..."
            pip install -r requirements.txt
          fi
          echo "âœ… Dependencies installed"
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2: Extract Jira Issue Key from Branch/PR/Commits
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Extract Jira Issue Key
        id: jira
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 2: Extracting Jira issue key"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Try 1: Extract from branch name
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "ğŸ” Checking branch name: $BRANCH_NAME"
          JIRA_KEY=$(echo "$BRANCH_NAME" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
          
          # Try 2: Extract from PR title
          if [ -z "$JIRA_KEY" ]; then
            echo "ğŸ” Checking PR title..."
            JIRA_KEY=$(echo "${{ github.event.pull_request.title }}" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
          fi
          
          # Try 3: Extract from commit messages
          if [ -z "$JIRA_KEY" ]; then
            echo "ğŸ” Checking commit messages..."
            JIRA_KEY=$(git log -5 --pretty=%B | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
          fi
          
          if [ -n "$JIRA_KEY" ]; then
            echo "âœ… Found Jira issue: $JIRA_KEY"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "has_jira=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  No Jira issue found"
            echo "has_jira=false" >> $GITHUB_OUTPUT
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: Show What Files Will Be Tested
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Discovery - Show Source Files
        id: discovery
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 3: Discovering source files for regression testing"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          SOURCE_FILES=$(find . -name "*.py" -type f | \
            grep -v test_ | \
            grep -v generate | \
            grep -v .venv | \
            grep -v venv | \
            grep -v site-packages | \
            grep -v .github | \
            grep -v "scripts/" | \
            grep -v __pycache__ | \
            sort)
          
          if [ -z "$SOURCE_FILES" ]; then
            echo "âš ï¸  No source files found!"
            echo "files_found=0" >> $GITHUB_OUTPUT
            echo "None" > /tmp/source_files_regression.txt
          else
            echo "$SOURCE_FILES"
            SOURCE_COUNT=$(echo "$SOURCE_FILES" | wc -l | tr -d ' ')
            echo "ğŸ“Š Total source files: $SOURCE_COUNT"
            echo "files_found=$SOURCE_COUNT" >> $GITHUB_OUTPUT
            echo "$SOURCE_FILES" > /tmp/source_files_regression.txt
            
            if [ "$SOURCE_COUNT" -gt 1 ]; then
              echo "âš ï¸  WARNING: Multiple source files detected!"
              echo "multiple_files=true" >> $GITHUB_OUTPUT
            else
              echo "multiple_files=false" >> $GITHUB_OUTPUT
            fi
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Clean Up Old Generated Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§¹ Cleanup - Remove Old Generated Tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 4: Cleaning up old generated test files"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ—‘ï¸  Removing: test_auto_generated.py test_ai_generated.py"
          rm -f test_auto_generated.py test_ai_generated.py
          echo "âœ… Cleanup complete - starting fresh!"
          echo ""

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5: AI Generates Regression Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¤– AI Generation - Generate 5 Regression Tests
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          TRACKER_ENDPOINT: ${{ secrets.TRACKER_ENDPOINT }}    # â† ADD
          TRACKER_API_KEY: ${{ secrets.TRACKER_API_KEY }}      # â† ADD 
          AGENT_NAME: AUTO_TEST  
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 5: AI generating 5 regression test cases"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          python scripts/generate_tests.py || {
            echo "âš ï¸  Generator script failed but continuing..."
            exit 0
          }
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 6: Show What Tests Were Generated
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“‹ Results - Show Generated Regression Tests
        id: results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 6: Showing generated regression test file"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ -f test_ai_generated.py ]; then
            echo "âœ… File created: test_ai_generated.py"
            echo ""
            cat test_ai_generated.py
            echo ""
            TEST_COUNT=$(grep -c "def test_ai_generated_" test_ai_generated.py || echo "0")
            echo "ğŸ“Š Total regression tests generated: $TEST_COUNT"
            echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT
            
            # Save test functions to temp file
            grep "def test_" test_ai_generated.py | sed 's/def //' | sed 's/(.*//' > /tmp/test_functions_regression.txt || echo "None" > /tmp/test_functions_regression.txt
            
            if [ "$TEST_COUNT" -ne 5 ]; then
              echo "âš ï¸  Expected 5 tests, got $TEST_COUNT"
              echo "expected_count=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Correct number of tests generated (5)"
              echo "expected_count=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No test file was generated!"
            echo "test_count=0" >> $GITHUB_OUTPUT
            echo "None" > /tmp/test_functions_regression.txt
            echo "expected_count=false" >> $GITHUB_OUTPUT
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 7: Ensure Test File Exists (Safety Fallback)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ›¡ï¸ Safety - Ensure Test File Exists
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 7: Safety check - ensuring test file exists"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ ! -f test_ai_generated.py ]; then
            echo "âš ï¸  No test file found - creating emergency fallback..."
            echo "def test_fallback(): assert True  # Emergency fallback test" > test_ai_generated.py
            echo "âœ… Fallback test created"
          else
            echo "âœ… Test file exists - no fallback needed"
          fi
          echo ""

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 8: Run Regression Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§ª Execution - Run Regression Tests
        id: pytest
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 8: Running AI-generated regression tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          pytest test_ai_generated.py -v --tb=short > /tmp/test_results_regression.txt 2>&1 || true
          cat /tmp/test_results_regression.txt
          
          # Check if tests passed
          if grep -q "passed" /tmp/test_results_regression.txt; then
            echo "status=âœ… PASSED" >> $GITHUB_OUTPUT
            echo "status_text=PASSED" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ FAILED" >> $GITHUB_OUTPUT
            echo "status_text=FAILED" >> $GITHUB_OUTPUT
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Regression tests workflow complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 9: Post Results to PR Comment (GitHub)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Post Results to PR
        if: github.event_name == 'pull_request' || github.event.pull_request != null
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const filesFound = '${{ steps.discovery.outputs.files_found }}';
            const multipleFiles = '${{ steps.discovery.outputs.multiple_files }}';
            const testCount = '${{ steps.results.outputs.test_count }}';
            const expectedCount = '${{ steps.results.outputs.expected_count }}';
            const status = '${{ steps.pytest.outputs.status }}';
            const hasJira = '${{ steps.jira.outputs.has_jira }}';
            const jiraKey = '${{ steps.jira.outputs.jira_key }}';
            
            let sourceFiles = 'None';
            let testFunctions = 'None';
            let testOutput = 'No output';
            
            try { sourceFiles = fs.readFileSync('/tmp/source_files_regression.txt', 'utf8').trim(); } catch (e) {}
            try { testFunctions = fs.readFileSync('/tmp/test_functions_regression.txt', 'utf8').trim(); } catch (e) {}
            try { testOutput = fs.readFileSync('/tmp/test_results_regression.txt', 'utf8').trim(); } catch (e) {}
            
            let warningSection = '';
            if (multipleFiles === 'true') {
              warningSection = `
            ## âš ï¸ Warning: Multiple Source Files Detected
            
            The AI found multiple source files and generated regression tests for **all of them**:
            \`\`\`
            ${sourceFiles}
            \`\`\`
            `;
            }
            
            let countWarning = '';
            if (expectedCount === 'false') {
              countWarning = `\nâš ï¸ **Expected 5 tests, but got ${testCount}**\n`;
            }
            
            let jiraSection = '';
            if (hasJira === 'true') {
              jiraSection = `\n### ğŸ« Jira Integration\nâœ… Results will be posted to: **${jiraKey}**\n`;
            } else {
              jiraSection = `\n### ğŸ« Jira Integration\nâš ï¸ No Jira issue detected. Include issue key in branch name (e.g., \`feature/PROJ-123-description\`) for automatic linking.\n`;
            }
            
            const comment = `## ğŸ¤– AI Regression Tests Report
            
            ${status}
            
            ### ğŸ“Š Summary
            - **Source Files Found:** ${filesFound}
            - **Regression Tests Generated:** ${testCount} ${expectedCount === 'true' ? 'âœ…' : 'âš ï¸'}
            ${countWarning}
            ${jiraSection}
            
            ### ğŸ¯ Source Files Tested
            \`\`\`
            ${sourceFiles}
            \`\`\`
            
            ${warningSection}
            
            ### ğŸ§ª Generated Regression Tests
            \`\`\`python
            ${testFunctions}
            \`\`\`
            
            ### ğŸ“‹ Test Results
            <details>
            <summary>Click to see full pytest output</summary>
            
            \`\`\`
            ${testOutput}
            \`\`\`
            </details>
            
            ---
            *ğŸ¤– This comment was automatically generated by AI Regression Tests workflow*`;
            
            const prNumber = context.payload.pull_request?.number || context.issue?.number;
            
            if (prNumber) {
              github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 10: Post Results to Jira Ticket
      # ğŸ”§ FIXED: Using Python for proper JSON encoding
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“ Post Results to Jira
        if: steps.jira.outputs.has_jira == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_KEY: ${{ steps.jira.outputs.jira_key }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
          STATUS: ${{ steps.pytest.outputs.status_text }}
          TEST_COUNT: ${{ steps.results.outputs.test_count }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 10: Posting results to Jira ticket $JIRA_KEY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_USER_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "âš ï¸  Jira credentials not configured - skipping Jira comment"
            echo "   Add secrets: JIRA_BASE_URL, JIRA_USER_EMAIL, JIRA_API_TOKEN"
            exit 0
          fi
          
          # Use Python to properly encode JSON
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import requests
          from requests.auth import HTTPBasicAuth
          
          # Read test results from files
          def read_file(path):
              try:
                  with open(path, 'r') as f:
                      return f.read().strip()
              except:
                  return "N/A"
          
          source_files = read_file('/tmp/source_files_regression.txt')
          test_functions = read_file('/tmp/test_functions_regression.txt')
          test_output = read_file('/tmp/test_results_regression.txt')
          
          # Get environment variables
          jira_base_url = os.environ['JIRA_BASE_URL']
          jira_email = os.environ['JIRA_USER_EMAIL']
          jira_token = os.environ['JIRA_API_TOKEN']
          jira_key = os.environ['JIRA_KEY']
          github_url = os.environ['GITHUB_RUN_URL']
          branch = os.environ['BRANCH_NAME']
          status = os.environ['STATUS']
          test_count = os.environ['TEST_COUNT']
          
          # Truncate long outputs
          if len(test_output) > 3000:
              test_output = test_output[:3000] + "\n\n... (truncated, see GitHub Actions for full output)"
          
          # Create Jira comment using ADF (Atlassian Document Format)
          comment_body = {
              "body": {
                  "type": "doc",
                  "version": 1,
                  "content": [
                      {
                          "type": "heading",
                          "attrs": {"level": 2},
                          "content": [{"type": "text", "text": f"ğŸ¤– AI Regression Tests - {status}"}]
                      },
                      {
                          "type": "paragraph",
                          "content": [
                              {"type": "text", "text": "Triggered by: ", "marks": [{"type": "strong"}]},
                              {"type": "text", "text": "GitHub Actions", "marks": [{"type": "link", "attrs": {"href": github_url}}]}
                          ]
                      },
                      {
                          "type": "paragraph",
                          "content": [
                              {"type": "text", "text": "Branch: ", "marks": [{"type": "strong"}]},
                              {"type": "text", "text": branch, "marks": [{"type": "code"}]}
                          ]
                      },
                      {
                          "type": "heading",
                          "attrs": {"level": 3},
                          "content": [{"type": "text", "text": "Summary"}]
                      },
                      {
                          "type": "bulletList",
                          "content": [
                              {
                                  "type": "listItem",
                                  "content": [
                                      {
                                          "type": "paragraph",
                                          "content": [
                                              {"type": "text", "text": f"Tests Generated: {test_count}"}
                                          ]
                                      }
                                  ]
                              },
                              {
                                  "type": "listItem",
                                  "content": [
                                      {
                                          "type": "paragraph",
                                          "content": [
                                              {"type": "text", "text": f"Status: {status}"}
                                          ]
                                      }
                                  ]
                              }
                          ]
                      },
                      {
                          "type": "heading",
                          "attrs": {"level": 3},
                          "content": [{"type": "text", "text": "Source Files Tested"}]
                      },
                      {
                          "type": "codeBlock",
                          "content": [{"type": "text", "text": source_files}]
                      },
                      {
                          "type": "heading",
                          "attrs": {"level": 3},
                          "content": [{"type": "text", "text": "Generated Test Functions"}]
                      },
                      {
                          "type": "codeBlock",
                          "attrs": {"language": "python"},
                          "content": [{"type": "text", "text": test_functions}]
                      },
                      {
                          "type": "heading",
                          "attrs": {"level": 3},
                          "content": [{"type": "text", "text": "Test Results"}]
                      },
                      {
                          "type": "codeBlock",
                          "content": [{"type": "text", "text": test_output}]
                      },
                      {
                          "type": "paragraph",
                          "content": [
                              {"type": "text", "text": "Automated by GitHub Actions CI/CD Pipeline", "marks": [{"type": "em"}]}
                          ]
                      }
                  ]
              }
          }
          
          # Post to Jira
          url = f"{jira_base_url}/rest/api/3/issue/{jira_key}/comment"
          
          print(f"ğŸ“¤ Posting to: {url}")
          
          try:
              response = requests.post(
                  url,
                  json=comment_body,
                  auth=HTTPBasicAuth(jira_email, jira_token),
                  headers={"Content-Type": "application/json"}
              )
              
              if response.status_code in [200, 201]:
                  print(f"âœ… Successfully posted comment to Jira ticket {jira_key}")
                  print(f"   View at: {jira_base_url}/browse/{jira_key}")
              else:
                  print(f"âŒ Failed to post to Jira (HTTP {response.status_code})")
                  print(f"Response: {response.text}")
                  print("\nğŸ’¡ Troubleshooting tips:")
                  print("   1. Verify Jira credentials are correct")
                  print(f"   2. Check if issue {jira_key} exists")
                  print("   3. Ensure API token has permission to comment")
                  print("   4. Verify JIRA_BASE_URL has no trailing slash")
          except Exception as e:
              print(f"âŒ Error posting to Jira: {e}")
          
          PYTHON_SCRIPT
          
          echo ""
