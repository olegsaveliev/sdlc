name: ğŸš€ Master Delivery Pipeline

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '.github/workflows/**'
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.editorconfig'
      - 'PROJECT_GUIDE*.md'
      - 'PR_APPROVAL*.md'
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: AI Code Review (runs first for quick feedback)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  call-pr-review:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/pr_review.yml
    permissions:
      contents: read
      pull-requests: write
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      TRACKER_ENDPOINT: ${{ secrets.TRACKER_ENDPOINT }}
      TRACKER_API_KEY: ${{ secrets.TRACKER_API_KEY }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: Run Unit Tests (ONLY on Pull Requests)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  call-quality:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/unit_tests.yml
    permissions:
      contents: read
      pull-requests: write
      issues: write
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      TRACKER_ENDPOINT: ${{ secrets.TRACKER_ENDPOINT }}
      TRACKER_API_KEY: ${{ secrets.TRACKER_API_KEY }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: Run Regression Tests (ONLY on Pull Requests)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  call-ai-autotest:
    needs: call-quality
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/auto_test.yml
    permissions:
      contents: read
      pull-requests: write
      issues: write
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      TRACKER_ENDPOINT: ${{ secrets.TRACKER_ENDPOINT }}
      TRACKER_API_KEY: ${{ secrets.TRACKER_API_KEY }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: Deploy to Staging (ONLY after merge to main)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  call-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/staging_release.yml
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
