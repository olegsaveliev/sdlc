name: ðŸš€ Master Delivery Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # STEP 1: Run unit tests (on PR and push)
  call-quality:
    uses: ./.github/workflows/unit_tests.yml
    permissions:
      contents: read
      pull-requests: write
      issues: write
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}

  # STEP 2: Run regression tests (only after merge to main)
  call-ai-autotest:
    needs: call-quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/auto_test.yml
    permissions:
      contents: read
      pull-requests: write
      issues: write
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
      # Jira integration - posts autotest results to Jira tickets
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

  # STEP 3: Deploy to staging (only after tests pass)
  call-staging:
    needs: call-ai-autotest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/staging_release.yml
