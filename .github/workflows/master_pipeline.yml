name: ðŸš€ Master Delivery Pipeline (No Duplicates)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # UNIT TESTS - Only on PR (not on merge)
  call-quality:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/unit_tests.yml
    permissions:
      contents: read
      pull-requests: write
      issues: write
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}

  # REGRESSION TESTS - Only after merge to main
  call-ai-autotest:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/auto_test.yml
    secrets:
      OPENAI_KEY: ${{ secrets.OPENAI_KEY }}

  # DEPLOY - Only after regression tests pass
  call-staging:
    needs: call-ai-autotest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/staging_release.yml
