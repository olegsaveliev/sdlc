name: Module - AI PR Review

on:
  workflow_call:
    secrets:
      OPENAI_KEY:
        required: true
      TRACKER_ENDPOINT:
        required: false
      TRACKER_API_KEY:
        required: false
      SLACK_PR_REVIEW:
        required: false
        description: "Slack webhook URL for notifications"

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      review_status: ${{ steps.review.outputs.review_status }}
      has_critical: ${{ steps.review.outputs.has_critical }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install openai requests gitpython
      
      - name: ğŸ” Debug Environment
        env:
          TRACKER_ENDPOINT: ${{ secrets.TRACKER_ENDPOINT }}
          TRACKER_API_KEY: ${{ secrets.TRACKER_API_KEY }}
        run: |
          echo "Tracker endpoint set: $([[ -n "$TRACKER_ENDPOINT" ]] && echo 'YES' || echo 'NO')"
          echo "Tracker API key set: $([[ -n "$TRACKER_API_KEY" ]] && echo 'YES' || echo 'NO')"
      
      - name: ğŸ¤– Run AI PR Review
        id: review
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_PR_REVIEW }}
          TRACKER_ENDPOINT: ${{ secrets.TRACKER_ENDPOINT }}
          TRACKER_API_KEY: ${{ secrets.TRACKER_API_KEY }}
          AGENT_NAME: PR_REVIEW
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          BASE_REF: ${{ github.base_ref }}
          HEAD_REF: ${{ github.head_ref }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python scripts/pr_review_agent.py > /tmp/pr_review_output.txt 2>&1
          
          # Capture the output for posting to GitHub
          cat /tmp/pr_review_output.txt
          
          # Extract review status from output (look for approval markers)
          if grep -q "âœ…" /tmp/pr_review_output.txt && ! grep -q "ğŸ”´" /tmp/pr_review_output.txt; then
            echo "review_status=APPROVED" >> $GITHUB_OUTPUT
            echo "has_critical=false" >> $GITHUB_OUTPUT
          elif grep -q "ğŸ”´" /tmp/pr_review_output.txt; then
            echo "review_status=CRITICAL" >> $GITHUB_OUTPUT
            echo "has_critical=true" >> $GITHUB_OUTPUT
          else
            echo "review_status=NEEDS_CHANGES" >> $GITHUB_OUTPUT
            echo "has_critical=false" >> $GITHUB_OUTPUT
          fi
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # â­ NEW: Post AI Review to GitHub PR Comment
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Post AI Review to GitHub PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the review output
            let reviewContent = 'No review content available';
            try {
              reviewContent = fs.readFileSync('/tmp/pr_review_output.txt', 'utf8').trim();
            } catch (e) {
              console.log('Could not read review output:', e);
            }
            
            // Extract just the AI analysis section (after "AI Analysis" header)
            const aiAnalysisMatch = reviewContent.match(/ğŸ” AI Analysis[\s\S]*$/m);
            const aiAnalysis = aiAnalysisMatch ? aiAnalysisMatch[0] : reviewContent;
            
            // Get status
            const reviewStatus = '${{ steps.review.outputs.review_status }}';
            const hasCritical = '${{ steps.review.outputs.has_critical }}';
            
            // Determine status emoji
            let statusEmoji = 'âš ï¸';
            let statusText = 'Needs Changes';
            if (reviewStatus === 'APPROVED') {
              statusEmoji = 'âœ…';
              statusText = 'Approved';
            } else if (hasCritical === 'true') {
              statusEmoji = 'ğŸ”´';
              statusText = 'Critical Issues Found';
            }
            
            // Get files reviewed
            const changedFiles = '${{ github.event.pull_request.changed_files }}';
            
            const comment = `## ğŸ¤– AI Code Review
            
            ${statusEmoji} **Status: ${statusText}**
            
            ### ğŸ“Š Summary
            - **Files Changed:** ${changedFiles}
            - **Review Status:** ${statusText}
            - **Model:** GPT-4o-mini
            
            ### ğŸ” AI Analysis
            
            <details>
            <summary>Click to see full AI review</summary>
            
            ${aiAnalysis}
            
            </details>
            
            ### ğŸ’¡ About This Review
            This review analyzed the actual code in your changed files (not just the diff). The AI checked for:
            - ğŸ› Bugs & Logic Errors
            - ğŸ”’ Security Issues
            - âš¡ Performance Problems
            - ğŸ“– Code Quality
            - ğŸ§ª Testing Needs
            - ğŸ“š Documentation Gaps
            
            **Helpful?** React with ğŸ‘ or ğŸ‘
            
            ---
            *ğŸ¤– Automated by AI PR Review Agent | [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            // Check if there's an existing AI review comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.body.includes('ğŸ¤– AI Code Review') && 
              comment.user.type === 'Bot'
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… Updated existing AI review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… Posted new AI review comment');
            }
