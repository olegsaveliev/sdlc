name: Module - AI PR Review

on:
  workflow_call:
    secrets:
      OPENAI_KEY:
        required: true

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for diff
      
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Install Dependencies
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 1: Installing dependencies for AI PR Review"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pip install openai requests
          echo "âœ… Dependencies installed"
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2: Get PR Changes
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“ Get PR Diff
        id: diff
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 2: Fetching PR changes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Get the base branch
          git fetch origin ${{ github.base_ref }}
          
          # Get diff between base and current branch
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)
          
          if [ -z "$DIFF" ]; then
            echo "âš ï¸  No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Changes detected"
            echo "$DIFF" > /tmp/pr_diff.txt
            
            # Get stats
            FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
            LINES_ADDED=$(echo "$DIFF" | grep "^+" | grep -v "^+++" | wc -l)
            LINES_REMOVED=$(echo "$DIFF" | grep "^-" | grep -v "^---" | wc -l)
            
            echo "ğŸ“Š Changes:"
            echo "   Files: $FILES_CHANGED"
            echo "   Lines added: $LINES_ADDED"
            echo "   Lines removed: $LINES_REMOVED"
            
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
            echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
            echo "lines_removed=$LINES_REMOVED" >> $GITHUB_OUTPUT
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: AI Code Review
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¤– AI Code Review
        if: steps.diff.outputs.has_changes == 'true'
        id: review
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 3: AI analyzing code changes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          from openai import OpenAI
          
          # Read the diff
          with open('/tmp/pr_diff.txt', 'r') as f:
              diff_content = f.read()
          
          # Truncate if too large (max ~8000 chars for context)
          if len(diff_content) > 8000:
              diff_content = diff_content[:8000] + "\n\n... (diff truncated for review)"
          
          # Initialize OpenAI client
          client = OpenAI(api_key=os.environ['OPENAI_KEY'])
          
          # Create prompt for code review
          prompt = f"""You are an expert code reviewer. Review this pull request diff and provide constructive feedback.

Focus on:
1. ğŸ› **Bugs & Issues**: Logic errors, potential bugs, edge cases
2. ğŸ”’ **Security**: Security vulnerabilities, input validation
3. âš¡ **Performance**: Inefficiencies, optimization opportunities
4. ğŸ“– **Code Quality**: Readability, maintainability, best practices
5. ğŸ§ª **Testing**: Missing tests, test coverage gaps
6. ğŸ“š **Documentation**: Missing comments, unclear code

Format your response as:
- Start with an overall assessment (looks good / needs attention / critical issues)
- List specific suggestions with file names and line numbers when possible
- Be constructive and helpful, not just critical
- Prioritize issues by severity (ğŸ”´ Critical, ğŸŸ¡ Important, ğŸŸ¢ Suggestion)
- End with positive feedback on what was done well

PR Diff:
```
{diff_content}
```

Provide your review:"""
          
          try:
              response = client.chat.completions.create(
                  model='gpt-4',
                  messages=[{'role': 'user', 'content': prompt}],
                  temperature=0.3,
                  max_tokens=1500
              )
              
              review_text = response.choices[0].message.content
              
              # Save review to file
              with open('/tmp/ai_review.txt', 'w') as f:
                  f.write(review_text)
              
              print("âœ… AI review completed")
              print("\n" + "="*60)
              print(review_text)
              print("="*60)
              
          except Exception as e:
              print(f"âŒ Error during AI review: {e}")
              with open('/tmp/ai_review.txt', 'w') as f:
                  f.write(f"âš ï¸ AI review failed: {e}\n\nPlease review manually.")
          
          PYTHON_SCRIPT
          
          echo ""
          echo "âœ… AI code review complete"
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Post Review Comment to PR
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Post AI Review to PR
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read AI review
            let aiReview = 'No review generated';
            try {
              aiReview = fs.readFileSync('/tmp/ai_review.txt', 'utf8');
            } catch (e) {
              console.error('Could not read review file:', e);
            }
            
            // Get PR stats
            const filesChanged = '${{ steps.diff.outputs.files_changed }}';
            const linesAdded = '${{ steps.diff.outputs.lines_added }}';
            const linesRemoved = '${{ steps.diff.outputs.lines_removed }}';
            
            // Create comment
            const comment = `## ğŸ¤– AI Code Review
            
            ### ğŸ“Š PR Statistics
            - **Files Changed:** ${filesChanged}
            - **Lines Added:** +${linesAdded}
            - **Lines Removed:** -${linesRemoved}
            
            ---
            
            ### ğŸ” AI Analysis
            
            ${aiReview}
            
            ---
            
            ### ğŸ’¡ About This Review
            This automated review was generated by GPT-4 to help catch potential issues early. Please use human judgment for final decisions.
            
            **Helpful?** ğŸ‘ or ğŸ‘ to provide feedback
            
            ---
            *ğŸ¤– Automated PR Review by AI Agent | [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            // Check if we already posted a review
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¤– AI Code Review')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… Updated existing AI review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… Posted new AI review comment');
            }
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5: Summary
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âœ… Review Complete
        if: steps.diff.outputs.has_changes == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… AI PR Review workflow complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Review has been posted to the PR"
          echo "ğŸ” Check the PR comments for AI suggestions"
          echo ""
