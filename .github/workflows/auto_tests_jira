name: Module - AI Automation Tests

on:
  workflow_call:
    secrets:
      OPENAI_KEY:
        required: true
      JIRA_BASE_URL:
        required: false
      JIRA_USER_EMAIL:
        required: false
      JIRA_API_TOKEN:
        required: false

jobs:
  generate-and-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 1: Install Dependencies
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 1: Installing Python dependencies"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pip install openai pytest httpx
          if [ -f requirements.txt ]; then
            echo "ğŸ“„ Found requirements.txt - installing..."
            pip install -r requirements.txt
          fi
          echo "âœ… Dependencies installed"
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 2: Extract Jira Issue Key from Branch/PR
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Extract Jira Issue Key
        id: jira
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 2: Extracting Jira issue key"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Try to extract from branch name (e.g., feature/PROJ-123-add-login)
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $BRANCH_NAME"
          
          # Look for pattern like PROJ-123, ABC-456, etc.
          JIRA_KEY=$(echo "$BRANCH_NAME" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
          
          if [ -z "$JIRA_KEY" ]; then
            # Try to extract from PR title or commit message
            JIRA_KEY=$(echo "${{ github.event.pull_request.title }}" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
          fi
          
          if [ -n "$JIRA_KEY" ]; then
            echo "âœ… Found Jira issue: $JIRA_KEY"
            echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT
            echo "has_jira=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  No Jira issue found in branch name or PR title"
            echo "has_jira=false" >> $GITHUB_OUTPUT
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 3: Show What Files Will Be Tested
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Discovery - Show Source Files
        id: discovery
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 3: Discovering source files for regression testing"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          SOURCE_FILES=$(find . -name "*.py" -type f | \
            grep -v test_ | \
            grep -v generate | \
            grep -v .venv | \
            grep -v venv | \
            grep -v site-packages | \
            grep -v .github | \
            grep -v "scripts/" | \
            grep -v __pycache__ | \
            sort)
          
          if [ -z "$SOURCE_FILES" ]; then
            echo "âš ï¸  No source files found!"
            echo "files_found=0" >> $GITHUB_OUTPUT
            echo "None" > /tmp/source_files_regression.txt
          else
            echo "$SOURCE_FILES"
            SOURCE_COUNT=$(echo "$SOURCE_FILES" | wc -l | tr -d ' ')
            echo "ğŸ“Š Total source files: $SOURCE_COUNT"
            echo "files_found=$SOURCE_COUNT" >> $GITHUB_OUTPUT
            echo "$SOURCE_FILES" > /tmp/source_files_regression.txt
            
            if [ "$SOURCE_COUNT" -gt 1 ]; then
              echo "âš ï¸  WARNING: Multiple source files detected!"
              echo "multiple_files=true" >> $GITHUB_OUTPUT
            else
              echo "multiple_files=false" >> $GITHUB_OUTPUT
            fi
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 4: Clean Up Old Generated Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§¹ Cleanup - Remove Old Generated Tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 4: Cleaning up old generated test files"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ—‘ï¸  Removing: test_auto_generated.py test_ai_generated.py"
          rm -f test_auto_generated.py test_ai_generated.py
          echo "âœ… Cleanup complete - starting fresh!"
          echo ""

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 5: AI Generates Regression Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¤– AI Generation - Generate 5 Regression Tests
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 5: AI generating 5 regression test cases"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          python scripts/generate_tests.py || {
            echo "âš ï¸  Generator script failed but continuing..."
            exit 0
          }
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 6: Show What Tests Were Generated
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“‹ Results - Show Generated Regression Tests
        id: results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 6: Showing generated regression test file"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ -f test_ai_generated.py ]; then
            echo "âœ… File created: test_ai_generated.py"
            echo ""
            cat test_ai_generated.py
            echo ""
            TEST_COUNT=$(grep -c "def test_ai_generated_" test_ai_generated.py || echo "0")
            echo "ğŸ“Š Total regression tests generated: $TEST_COUNT"
            echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT
            
            # Save test functions to temp file
            grep "def test_" test_ai_generated.py | sed 's/def //' | sed 's/(.*//' > /tmp/test_functions_regression.txt || echo "None" > /tmp/test_functions_regression.txt
            
            if [ "$TEST_COUNT" -ne 5 ]; then
              echo "âš ï¸  Expected 5 tests, got $TEST_COUNT"
              echo "expected_count=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Correct number of tests generated (5)"
              echo "expected_count=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No test file was generated!"
            echo "test_count=0" >> $GITHUB_OUTPUT
            echo "None" > /tmp/test_functions_regression.txt
            echo "expected_count=false" >> $GITHUB_OUTPUT
          fi
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 7: Ensure Test File Exists (Safety Fallback)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ›¡ï¸ Safety - Ensure Test File Exists
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 7: Safety check - ensuring test file exists"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ ! -f test_ai_generated.py ]; then
            echo "âš ï¸  No test file found - creating emergency fallback..."
            echo "def test_fallback(): assert True  # Emergency fallback test" > test_ai_generated.py
            echo "âœ… Fallback test created"
          else
            echo "âœ… Test file exists - no fallback needed"
          fi
          echo ""

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 8: Run Regression Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§ª Execution - Run Regression Tests
        id: pytest
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 8: Running AI-generated regression tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          pytest test_ai_generated.py -v --tb=short > /tmp/test_results_regression.txt 2>&1 || true
          cat /tmp/test_results_regression.txt
          
          # Check if tests passed
          if grep -q "passed" /tmp/test_results_regression.txt; then
            echo "status=âœ… PASSED" >> $GITHUB_OUTPUT
            echo "status_text=PASSED" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸ FAILED" >> $GITHUB_OUTPUT
            echo "status_text=FAILED" >> $GITHUB_OUTPUT
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Regression tests workflow complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 9: Post Results to PR Comment (GitHub)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’¬ Post Results to PR
        if: github.event_name == 'pull_request' || github.event.pull_request != null
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const filesFound = '${{ steps.discovery.outputs.files_found }}';
            const multipleFiles = '${{ steps.discovery.outputs.multiple_files }}';
            const testCount = '${{ steps.results.outputs.test_count }}';
            const expectedCount = '${{ steps.results.outputs.expected_count }}';
            const status = '${{ steps.pytest.outputs.status }}';
            
            let sourceFiles = 'None';
            let testFunctions = 'None';
            let testOutput = 'No output';
            
            try { sourceFiles = fs.readFileSync('/tmp/source_files_regression.txt', 'utf8').trim(); } catch (e) {}
            try { testFunctions = fs.readFileSync('/tmp/test_functions_regression.txt', 'utf8').trim(); } catch (e) {}
            try { testOutput = fs.readFileSync('/tmp/test_results_regression.txt', 'utf8').trim(); } catch (e) {}
            
            let warningSection = '';
            if (multipleFiles === 'true') {
              warningSection = `
            ## âš ï¸ Warning: Multiple Source Files Detected
            
            The AI found multiple source files and generated regression tests for **all of them**:
            \`\`\`
            ${sourceFiles}
            \`\`\`
            `;
            }
            
            let countWarning = '';
            if (expectedCount === 'false') {
              countWarning = `\nâš ï¸ **Expected 5 tests, but got ${testCount}**\n`;
            }
            
            const comment = `## ğŸ¤– AI Regression Tests Report
            
            ${status}
            
            ### ğŸ“Š Summary
            - **Source Files Found:** ${filesFound}
            - **Regression Tests Generated:** ${testCount} ${expectedCount === 'true' ? 'âœ…' : 'âš ï¸'}
            ${countWarning}
            
            ### ğŸ¯ Source Files Tested
            \`\`\`
            ${sourceFiles}
            \`\`\`
            
            ${warningSection}
            
            ### ğŸ§ª Generated Regression Tests
            \`\`\`python
            ${testFunctions}
            \`\`\`
            
            ### ğŸ“‹ Test Results
            <details>
            <summary>Click to see full pytest output</summary>
            
            \`\`\`
            ${testOutput}
            \`\`\`
            </details>
            
            ---
            *ğŸ¤– This comment was automatically generated by AI Regression Tests workflow*`;
            
            const prNumber = context.payload.pull_request?.number || context.issue?.number;
            
            if (prNumber) {
              github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # STEP 10: Post Results to Jira Ticket
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“ Post Results to Jira
        if: steps.jira.outputs.has_jira == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_KEY: ${{ steps.jira.outputs.jira_key }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "STEP 10: Posting results to Jira ticket $JIRA_KEY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ -z "$JIRA_BASE_URL" ] || [ -z "$JIRA_USER_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "âš ï¸  Jira credentials not configured - skipping Jira comment"
            echo "   Add secrets: JIRA_BASE_URL, JIRA_USER_EMAIL, JIRA_API_TOKEN"
            exit 0
          fi
          
          # Read test results
          SOURCE_FILES=$(cat /tmp/source_files_regression.txt)
          TEST_FUNCTIONS=$(cat /tmp/test_functions_regression.txt)
          TEST_OUTPUT=$(cat /tmp/test_results_regression.txt)
          STATUS="${{ steps.pytest.outputs.status_text }}"
          TEST_COUNT="${{ steps.results.outputs.test_count }}"
          
          # Create Jira comment body
          JIRA_COMMENT=$(cat <<EOF
          {
            "body": "h2. ğŸ¤– AI Regression Tests - ${STATUS}\n\n*Triggered by:* [GitHub Actions|${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}]\n\n*Branch:* {{${{ github.head_ref || github.ref_name }}}}\n\n*Summary:*\n* Tests Generated: ${TEST_COUNT}\n* Status: ${STATUS}\n\n*Source Files Tested:*\n{code}\n${SOURCE_FILES}\n{code}\n\n*Generated Test Functions:*\n{code:python}\n${TEST_FUNCTIONS}\n{code}\n\n*Test Results:*\n{code}\n${TEST_OUTPUT}\n{code}\n\n---\n_Automated by GitHub Actions CI/CD Pipeline_"
          }
          EOF
          )
          
          # Post to Jira
          HTTP_CODE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -d "$JIRA_COMMENT" \
            -w "%{http_code}" \
            -o /tmp/jira_response.txt \
            "${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment")
          
          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Successfully posted comment to Jira ticket ${JIRA_KEY}"
            echo "   View at: ${JIRA_BASE_URL}/browse/${JIRA_KEY}"
          else
            echo "âŒ Failed to post to Jira (HTTP ${HTTP_CODE})"
            echo "Response:"
            cat /tmp/jira_response.txt
          fi
          echo ""
